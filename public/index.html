<!doctype html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Boston Drink & Dessert</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="css/app.css" />
</head>

<body>
  <div class="bg-layer"></div>
  <div class="app-shell">
    <aside class="sidebar panel">
      <div class="sidebar-brand">
        <img class="brand-logo" src="images/boston-logo.png" alt="Boston Drink & Dessert" loading="lazy" />
        <p class="eyebrow">Boston Drink & Dessert</p>
        <h2>Yönetim Paneli</h2>
      </div>
      <nav class="sidebar-nav">
        <a id="navHomeLink" class="nav-link" href="./">Anasayfa</a>
        <a id="navUsageLink" class="nav-link hidden" href="usage">Kullanım Geçmişi</a>
        <a id="navAdminLink" class="nav-link hidden" href="admin">Admin Paneli</a>
      </nav>

      <div class="auth-card sidebar-auth">
        <div id="authState" class="auth-state guest">Misafir: Sadece görüntüleme</div>

        <form id="loginForm" class="auth-form">
          <input id="loginUsername" name="username" placeholder="Kullanıcı adı" autocomplete="username" />
          <input id="loginPassword" name="password" type="password" placeholder="Şifre" autocomplete="current-password" />
          <button type="submit">Giriş Yap</button>
        </form>
        <button id="logoutBtn" class="btn subtle hidden" type="button">Çıkış Yap</button>
      </div>
    </aside>

    <div class="content-shell">

      <section id="passwordGate" class="panel hidden password-panel">
    <h2>Şifre Güncelleme Gerekli</h2>
    <p>İlk girişten sonra devam etmek için şifrenizi değiştirin.</p>
    <form id="passwordForm" class="password-form">
      <input id="currentPassword" type="password" placeholder="Mevcut şifre" required />
      <input id="newPassword" type="password" placeholder="Yeni şifre (en az 8 karakter)" required />
      <button type="submit">Şifreyi Güncelle</button>
    </form>
      </section>

      <main id="mainPage" class="layout">
    <section class="kpi-grid">
      <article class="kpi">
        <span class="label">Toplam Stok Değeri</span>
        <strong id="kpiValue">₺0,00</strong>
      </article>
      <article class="kpi">
        <span class="label">Toplam Adet</span>
        <strong id="kpiQty">0</strong>
      </article>
      <article class="kpi">
        <span class="label">Aktif Ürün</span>
        <strong id="kpiActive">0</strong>
      </article>
      <article class="kpi warning">
        <span class="label">Düşük Stok</span>
        <strong id="kpiLow">0</strong>
      </article>
      <article class="kpi">
        <span class="label">Bitmeye Yakın</span>
        <strong id="kpiWarning">0</strong>
      </article>
    </section>

    <section class="panel alerts-panel">
      <div class="panel-head">
        <h2>Stok Uyarıları</h2>
      </div>
      <div class="alerts-grid">
        <div>
          <h3>Düşük Stok</h3>
          <ul id="lowAlertsList" class="alert-list"></ul>
        </div>
        <div>
          <h3>Bitmeye Yakın</h3>
          <ul id="warningAlertsList" class="alert-list"></ul>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-head">
        <h2>Ürün Stok Listesi</h2>
        <div class="panel-actions">
          <button id="openCreateBtn" class="btn hidden" type="button">Yeni Ürün</button>
        </div>
      </div>

      <div id="categoryTabs" class="category-tabs"></div>

      <div class="filters">
        <input id="searchInput" placeholder="Ürün adı veya stok kodu ara" />
        <select id="categorySelect">
          <option value="">Tüm Kategoriler</option>
        </select>
        <button id="reloadBtn" class="btn subtle" type="button">Yenile</button>
      </div>

      <div id="productTableWrap" class="table-wrap main-table">
        <table>
          <thead>
            <tr>
              <th data-sort="image_path" class="sortable">Foto</th>
              <th data-sort="stock_code" class="sortable">Stok Kodu</th>
              <th data-sort="name" class="sortable">Ürün</th>
              <th data-sort="category" class="sortable">Kategori</th>
              <th data-sort="supplier_price" class="sortable">Fiyat</th>
              <th data-sort="quantity" class="sortable">Miktar</th>
              <th data-sort="min_quantity" class="sortable">Uyarı Eşiği</th>
              <th data-sort="stock_value" class="sortable">Stok Değeri</th>
              <th data-sort="status" class="sortable">Durum</th>
              <th id="actionHeader" data-sort="actions" class="sortable hidden">İşlemler</th>
            </tr>
          </thead>
          <tbody id="productTableBody"></tbody>
        </table>
        <div id="scrollSentinel" class="scroll-sentinel"></div>
      </div>

      <div class="table-footer">
        <span id="paginationInfo">0 kayıt</span>
        <span id="loadingIndicator" class="hint hidden">Yükleniyor...</span>
      </div>
    </section>
      </main>

  <main id="adminPage" class="layout hidden">
    <section class="panel">
      <div class="panel-head">
        <h2>Admin Paneli</h2>
        <a class="btn subtle" href="./">Ana sayfa</a>
      </div>
      <p class="hint">Bu bölüm sadece administrator rolü için görünür.</p>
    </section>

    <section id="adminDenied" class="panel hidden">
      <h2>Yetki Gerekli</h2>
      <p class="hint">Bu sayfayı görüntülemek için administrator girişi gerekli.</p>
      <a class="btn subtle" href="./">Ana sayfaya dön</a>
    </section>

    <section id="usersPanel" class="panel hidden">
      <div class="panel-head">
        <h2>Kullanıcı Yönetimi (Admin)</h2>
        <div class="panel-actions">
          <button id="openCreateUserBtn" class="btn" type="button">Yeni Kullanıcı</button>
          <button id="refreshUsersBtn" class="btn subtle" type="button">Yenile</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Kullanıcı</th>
              <th>Rol</th>
              <th>Durum</th>
              <th>Son Giriş</th>
              <th>İşlemler</th>
            </tr>
          </thead>
          <tbody id="usersTableBody"></tbody>
        </table>
      </div>
    </section>

    <section id="logsPanel" class="panel hidden">
      <div class="panel-head">
        <h2>Aktivite Kayıtları</h2>
        <div class="inline-form compact">
          <select id="logActionFilter">
            <option value="">Tüm İşlemler</option>
            <option value="LOGIN">LOGIN</option>
            <option value="LOGOUT">LOGOUT</option>
            <option value="PASSWORD_CHANGE">PASSWORD_CHANGE</option>
            <option value="INSERT">INSERT</option>
            <option value="UPDATE">UPDATE</option>
            <option value="DELETE">DELETE</option>
          </select>
          <button id="loadLogsBtn" class="btn subtle" type="button">Kayıtları Yükle</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Tarih</th>
              <th>Kullanıcı</th>
              <th>İşlem</th>
              <th>Detay</th>
              <th>Kaynak</th>
            </tr>
          </thead>
          <tbody id="logTableBody"></tbody>
        </table>
      </div>
    </section>

    <section id="visitorsPanel" class="panel hidden">
      <div class="panel-head">
        <h2>Ziyaretçi Analitiği</h2>
        <div class="panel-actions">
          <button id="refreshVisitorsBtn" class="btn subtle" type="button">Yenile</button>
        </div>
      </div>

      <div class="kpi-grid visitor-kpi-grid">
        <article class="kpi">
          <span class="label">Toplam Ziyaret</span>
          <strong id="visitorTotal">0</strong>
        </article>
        <article class="kpi">
          <span class="label">Tekil IP</span>
          <strong id="visitorUnique">0</strong>
        </article>
        <article class="kpi">
          <span class="label">Bugün</span>
          <strong id="visitorToday">0</strong>
        </article>
        <article class="kpi">
          <span class="label">Son 24 Saat</span>
          <strong id="visitorLast24h">0</strong>
        </article>
      </div>
      <p id="visitorDeviceHint" class="hint">Cihaz dağılımı yükleniyor...</p>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Tarih</th>
              <th>IP</th>
              <th>Konum</th>
              <th>Cihaz</th>
              <th>Tarayıcı / OS</th>
              <th>Sayfa</th>
              <th>Referans</th>
            </tr>
          </thead>
          <tbody id="visitorsTableBody"></tbody>
        </table>
      </div>
    </section>
  </main>

      <main id="usagePage" class="layout hidden">
        <section id="usageDenied" class="panel hidden">
          <h2>Yetki Gerekli</h2>
          <p class="hint">Bu sayfayı görüntülemek için oturum açmanız gerekli.</p>
          <a class="btn subtle" href="./">Ana sayfaya dön</a>
        </section>

        <section id="usagePanel" class="panel hidden">
          <div class="panel-head">
            <h2>Kullanım Geçmişi</h2>
            <div class="panel-actions">
              <button id="runUsageAiBtn" class="btn hidden" type="button">AI ile Analiz Et</button>
              <button id="loadUsageBtn" class="btn subtle" type="button">Kayıtları Yenile</button>
            </div>
          </div>
          <p class="hint">Stok düşürüldüğünde, ürünün ne zaman ve ne kadar kullanıldığı burada görünür. Saatler İstanbul (TRT) saatine göre gösterilir.</p>

          <div id="usageInsightsBox" class="usage-insights">
            <div class="usage-cards">
              <article class="kpi">
                <span class="label">Son 3 Gün</span>
                <strong id="usage3dTotal">0</strong>
                <small id="usage3dDaily" class="hint">Günlük ort: 0</small>
              </article>
              <article class="kpi">
                <span class="label">Son 7 Gün</span>
                <strong id="usage7dTotal">0</strong>
                <small id="usage7dDaily" class="hint">Günlük ort: 0</small>
              </article>
              <article class="kpi">
                <span class="label">Son 30 Gün</span>
                <strong id="usage30dTotal">0</strong>
                <small id="usage30dWeekly" class="hint">Haftalık ort: 0</small>
              </article>
              <article class="kpi">
                <span class="label">Çikolata (30 Gün)</span>
                <strong id="usageChoco30d">0</strong>
                <small id="usageChocoUnit" class="hint">Birim: -</small>
              </article>
            </div>
            <div class="usage-top-products">
              <h3>En Çok Kullanılan 7 Ürün</h3>
              <div id="usageTopProducts" class="usage-top-track"></div>
            </div>
            <p id="usageAiSummary" class="hint usage-ai-summary">Kullanım özeti yükleniyor...</p>
            <div id="usageAiReport" class="usage-ai-report hidden"></div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Tarih</th>
                  <th>Ürün</th>
                  <th>Kullanım</th>
                  <th>Önce</th>
                  <th>Sonra</th>
                  <th>Kullanıcı</th>
                </tr>
              </thead>
              <tbody id="usageTableBody"></tbody>
            </table>
          </div>
        </section>
      </main>

      <footer class="site-footer">
        <div class="site-footer__inner">
          <span class="site-footer__owner">Umut Pınarbaşı</span>
          <a class="site-footer__wa" href="https://wa.me/905428018009" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp ile iletişime geç">
            <svg class="site-footer__wa-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M12.04 2.003A9.94 9.94 0 0 0 3.57 17.18L2 22l4.97-1.54A9.95 9.95 0 1 0 12.04 2.003Zm5.8 13.97c-.24.67-1.39 1.28-1.95 1.36c-.5.07-1.13.1-1.83-.12c-.42-.13-.95-.3-1.63-.6c-2.88-1.24-4.75-4.14-4.9-4.34c-.14-.2-1.17-1.56-1.17-2.98c0-1.42.74-2.11 1-2.4c.26-.3.57-.37.76-.37c.2 0 .38.01.55.02c.18.01.42-.07.65.48c.24.57.82 1.98.89 2.13c.08.16.13.35.03.56c-.1.2-.15.33-.3.5c-.14.17-.3.37-.43.5c-.14.14-.28.28-.12.56c.16.28.72 1.19 1.55 1.93c1.07.95 1.98 1.25 2.26 1.39c.28.14.44.12.6-.07c.2-.24.8-.94 1.01-1.26c.2-.31.41-.26.69-.16c.28.1 1.8.85 2.1 1c.3.15.5.22.57.34c.07.11.07.67-.17 1.34Z"/>
            </svg>
            WhatsApp: +90 542 801 80 09
          </a>
        </div>
      </footer>
    </div>
  </div>

  <section id="productModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="panel-head">
        <h2 id="productModalTitle">Ürün Düzenle</h2>
        <button id="closeProductModalBtn" class="btn subtle" type="button">Kapat</button>
      </div>

      <form id="productForm" class="modal-grid">
        <input type="hidden" id="productId" />
        <label>Stok Kodu
          <input id="productStockCode" required />
        </label>
        <label>Ürün Adı
          <input id="productName" required />
        </label>
        <label>Kategori
          <select id="productCategory" required></select>
        </label>
        <label>Fiyat (₺)
          <input id="productPrice" type="number" step="0.01" min="0" required />
        </label>
        <label>Birim
          <input id="productUnit" value="adet" />
        </label>
        <label>Düşük Stok Eşiği
          <input id="productMinQuantity" type="number" min="0" value="5" required />
        </label>

        <div class="modal-actions">
          <button id="submitProductBtn" type="submit">Kaydet</button>
        </div>
      </form>
    </div>
  </section>

  <section id="stockModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card compact">
      <div class="panel-head">
        <h2>Stok Güncelle</h2>
        <button id="closeStockModalBtn" class="btn subtle" type="button">Kapat</button>
      </div>

      <form id="stockForm" class="stock-form">
        <input type="hidden" id="stockProductId" />
        <div class="stock-stepper">
          <button type="button" class="btn subtle" data-delta="-1">-1</button>
          <button type="button" class="btn subtle" data-delta="-5">-5</button>
          <input id="stockQuantity" type="number" min="0" step="0.01" required placeholder="Miktar" />
          <button type="button" class="btn subtle" data-delta="1">+1</button>
          <button type="button" class="btn subtle" data-delta="5">+5</button>
        </div>
        <button type="submit">Stoğu Kaydet</button>
      </form>
    </div>
  </section>

  <section id="userModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="panel-head">
        <h2 id="userModalTitle">Kullanıcı Düzenle</h2>
        <button id="closeUserModalBtn" class="btn subtle" type="button">Kapat</button>
      </div>

      <form id="userForm" class="modal-grid">
        <input type="hidden" id="userId" />
        <label>Kullanıcı Adı
          <input id="userUsername" required />
        </label>
        <label>Rol
          <select id="userRole" required>
            <option value="admin">admin</option>
            <option value="manager">manager</option>
            <option value="guest">guest</option>
          </select>
        </label>
        <label class="inline-checkbox full-span">
          <input id="userIsActive" type="checkbox" checked />
          Aktif kullanıcı
        </label>

        <label id="userCreatePasswordWrap" class="full-span hidden">Geçici Şifre
          <input id="userCreatePassword" type="password" placeholder="En az 8 karakter" />
        </label>

        <div id="userPermissionSection" class="full-span">
          <div class="panel-head compact">
            <h3>Yetkiler</h3>
            <button id="applyRoleDefaultsBtn" class="btn subtle" type="button">Role Göre Doldur</button>
          </div>
          <div class="permission-grid">
            <label class="inline-checkbox"><input id="permCanUpdateStock" type="checkbox" /> Stok güncelle</label>
            <label class="inline-checkbox"><input id="permCanEditProduct" type="checkbox" /> Ürün düzenle</label>
            <label class="inline-checkbox"><input id="permCanDeleteProduct" type="checkbox" /> Ürün sil</label>
            <label class="inline-checkbox"><input id="permCanCreateProduct" type="checkbox" /> Ürün ekle</label>
            <label class="inline-checkbox"><input id="permCanViewLogs" type="checkbox" /> Log görüntüle</label>
            <label class="inline-checkbox"><input id="permCanManageUsers" type="checkbox" /> Kullanıcı yönet</label>
            <label class="inline-checkbox"><input id="permCanScanPdf" type="checkbox" /> PDF tara</label>
          </div>
        </div>

        <div id="userPasswordResetSection" class="full-span hidden">
          <div class="panel-head compact">
            <h3>Şifre Güncelle</h3>
          </div>
          <div class="inline-form compact">
            <input id="userNewPassword" type="password" placeholder="Yeni şifre (min 8)" />
            <button id="userResetPasswordBtn" class="btn subtle" type="button">Şifreyi Güncelle</button>
          </div>
        </div>

        <div class="modal-actions">
          <button id="saveUserBtn" type="submit">Kaydet</button>
        </div>
      </form>
    </div>
  </section>

  <div id="toast" class="toast hidden"></div>

  <script src="js/app.js" defer></script>
</body>

</html>
